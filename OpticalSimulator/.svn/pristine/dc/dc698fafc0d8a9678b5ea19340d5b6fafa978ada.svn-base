package br.upe.simulations;

import br.upe.base.ACOPHeuristic;
import br.upe.base.Amplifier;
import br.upe.base.AmplifierType;
import br.upe.base.ObjectiveFunction;
import br.upe.base.OpticalSignal;
import br.upe.heuristics.AsHB.AsHBFlex;
import br.upe.heuristics.lossComp.LossComp;
import br.upe.heuristics.maxGain.MaxGain;
import br.upe.heuristics.uiara.AdGC;
import br.upe.initializations.UniformInitialization;
import br.upe.metrics.BeckerNoiseFigureMetric;
import br.upe.metrics.GNLIMetric;
import br.upe.objfunctions.rn.NNFunction;
import br.upe.objfunctions.rn.util.NormalizationUtility;
import br.upe.objfunctions.rn.util.NormalizationUtilityFactory;
import br.upe.selection.MaxGainSelection;
import br.upe.selection.UiaraWeightSelection;
import br.upe.signal.factory.PowerMaskSignal;
import br.upe.simulations.simsetups.SimSetAMPVOA;
import br.upe.simulations.simsetups.SimulationSetup;

public class SimCompareHeuristics {

    public static void main(String[] args) {
	ACOPHeuristic heuristic;
	AmplifierType type = AmplifierType.EDFA_1_STG;

	NormalizationUtility nu = NormalizationUtilityFactory.getInstance().fabricate(type);
	ObjectiveFunction function = new NNFunction(nu); // LinearInterpolationFunction();

	System.out.println("-- NN --");

	int numberCh = 39;
	float pinSystem = -21f;
	SimulationSetup simSet = new SimSetAMPVOA(numberCh, pinSystem, 9f);
	float[] linLosses = simSet.getLINK_LOSSES();
	int numberAmplifiers = simSet.getNumberOfAmplifiers();

	BeckerNoiseFigureMetric nfMetric = new BeckerNoiseFigureMetric(linLosses);
	GNLIMetric gnliMetric = new GNLIMetric(100e9, numberCh, pinSystem, 100e3);

	// Definindo ganho máximo
	float maxPout = simSet.getMaxOutputPower();
	System.out.println(maxPout);

	PowerMaskSignal signal = new PowerMaskSignal(numberCh, type, simSet.getCHANNEL_POWER(), 30);
	OpticalSignal inputSignal = signal.createSignal();


	heuristic = new MaxGain(numberAmplifiers, linLosses, inputSignal, function);
	heuristic.setInitialization(new UniformInitialization(type));
	heuristic.setSelectionOp(new MaxGainSelection());
	heuristic.setVoaMaxAttenuation(simSet.getVOA_MAX_ATT());
	heuristic.setRoadmAttenuation(simSet.getROADM_ATT());
	heuristic.setMaxOutputPower(maxPout);
	Amplifier[] amplifiers = heuristic.execute();
	System.out.println("****** MaxGain ******");
	System.out.println("NF\tGF\tOSNR\tGNLI");
	OpticalSignal endSignal = heuristic.getMonitors()[numberAmplifiers - 1].getOutputSignal();
	System.out.printf("%2.3f\t%2.3f\t%2.3f\t", nfMetric.evaluate(amplifiers), heuristic.calculateTilt(endSignal),
		heuristic.calculateOSNR(endSignal));
	System.out.println(gnliMetric.evaluate(amplifiers));

	System.out.println("OSNR_edfa\tOSNR_nli\n" + gnliMetric.getOSNR_EDFA() + "\t" + gnliMetric.getOSNR_NLI());

	for (int i = 0; i < amplifiers.length; i++) {
	    System.out.println(amplifiers[i]);
	}
	System.out.println();

	heuristic = new AdGC(numberAmplifiers, linLosses, inputSignal, function);
	heuristic.setInitialization(new UniformInitialization(type));
	heuristic.setSelectionOp(new UiaraWeightSelection());
	heuristic.setVoaMaxAttenuation(simSet.getVOA_MAX_ATT());
	heuristic.setRoadmAttenuation(simSet.getROADM_ATT());
	heuristic.setMaxOutputPower(maxPout);

	// When the selection uses weight
	if (heuristic.getSelectionOp() instanceof UiaraWeightSelection) {
	    ((UiaraWeightSelection) heuristic.getSelectionOp()).setNFWeight(1);
	    ((UiaraWeightSelection) heuristic.getSelectionOp()).setGFWeight(0.5);
	}

	amplifiers = heuristic.execute();
	System.out.println("****** WAdGC ******");
	System.out.println("NF\tGF\tOSNR\tGNLI");
	endSignal = heuristic.getMonitors()[numberAmplifiers - 1].getOutputSignal();
	System.out.printf("%2.3f\t%2.3f\t%2.3f\t", nfMetric.evaluate(amplifiers), heuristic.calculateTilt(endSignal),
		heuristic.calculateOSNR(endSignal));
	System.out.println(gnliMetric.evaluate(amplifiers));

	System.out.println("OSNR_edfa\tOSNR_nli\n" + gnliMetric.getOSNR_EDFA() + "\t" + gnliMetric.getOSNR_NLI());

	for (int i = 0; i < amplifiers.length; i++) {
	    System.out.println(amplifiers[i]);
	}
	System.out.println();

	heuristic = new AsHBFlex(numberAmplifiers, linLosses, inputSignal, function);
	heuristic.setSelectionOp(new UiaraWeightSelection());
	heuristic.setInitialization(new UniformInitialization(type));
	heuristic.setVoaMaxAttenuation(simSet.getVOA_MAX_ATT());
	heuristic.setRoadmAttenuation(simSet.getROADM_ATT());
	heuristic.setMaxOutputPower(maxPout);
	((AsHBFlex) heuristic).setMaxIteration(5);
	amplifiers = heuristic.execute();
	System.out.println("****** AsHB Flex ******");
	System.out.println("NF\tGF\tOSNR\tGNLI");
	endSignal = heuristic.getMonitors()[numberAmplifiers - 1].getOutputSignal();
	System.out.printf("%2.3f\t%2.3f\t%2.3f\t", nfMetric.evaluate(amplifiers), heuristic.calculateTilt(endSignal),
		heuristic.calculateOSNR(endSignal));
	System.out.println(gnliMetric.evaluate(amplifiers));

	System.out.println("OSNR_edfa\tOSNR_nli\n" + gnliMetric.getOSNR_EDFA() + "\t" + gnliMetric.getOSNR_NLI());

	for (int i = 0; i < amplifiers.length; i++) {
	    System.out.println(amplifiers[i]);
	}
	System.out.println();

	heuristic = new LossComp(numberAmplifiers, linLosses, inputSignal, function);
	heuristic.setInitialization(new UniformInitialization(type));
	heuristic.setVoaMaxAttenuation(simSet.getVOA_MAX_ATT());
	heuristic.setRoadmAttenuation(simSet.getROADM_ATT());
	heuristic.setMaxOutputPower(maxPout);
	amplifiers = heuristic.execute();
	System.out.println("****** LossComp ******");
	System.out.println("NF\tGF\tOSNR\tGNLI");
	endSignal = heuristic.getMonitors()[numberAmplifiers - 1].getOutputSignal();
	System.out.printf("%2.3f\t%2.3f\t%2.3f\t", nfMetric.evaluate(amplifiers), heuristic.calculateTilt(endSignal),
		heuristic.calculateOSNR(endSignal));
	System.out.println(gnliMetric.evaluate(amplifiers));

	System.out.println("OSNR_edfa\tOSNR_nli\n" + gnliMetric.getOSNR_EDFA() + "\t" + gnliMetric.getOSNR_NLI());

	for (int i = 0; i < amplifiers.length; i++) {
	    System.out.println(amplifiers[i]);
	}
	System.out.println();
    }

}
